<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Time-slicing With Continuation-passing Style | Lei&#39;s Blog</title>
<meta name="keywords" content="CPS, non-blocking">
<meta name="description" content="Time-slicing With Continuation-passing Style to handle performance bottleneck">
<meta name="author" content="Lei Huang">
<link rel="canonical" href="https://leihuang.me/posts/time-slicing-with-cps/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.77fc57aba3c44dbadafdb9c47b4c24d5ca6ed89e1ee4e8a384d00a41e4e67074.css" integrity="sha256-d/xXq6PETbra/bnEe0wk1cpu2J4e5OijhNAKQeTmcHQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://leihuang.me/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://leihuang.me/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://leihuang.me/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://leihuang.me/apple-touch-icon.png">
<link rel="mask-icon" href="https://leihuang.me/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://leihuang.me/posts/time-slicing-with-cps/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://leihuang.me/posts/time-slicing-with-cps/">
  <meta property="og:site_name" content="Lei&#39;s Blog">
  <meta property="og:title" content="Time-slicing With Continuation-passing Style">
  <meta property="og:description" content="Time-slicing With Continuation-passing Style to handle performance bottleneck">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-08-06T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-08-06T00:00:00+00:00">
    <meta property="article:tag" content="CPS">
    <meta property="article:tag" content="Non-Blocking">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Time-slicing With Continuation-passing Style">
<meta name="twitter:description" content="Time-slicing With Continuation-passing Style to handle performance bottleneck">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://leihuang.me/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Time-slicing With Continuation-passing Style",
      "item": "https://leihuang.me/posts/time-slicing-with-cps/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Time-slicing With Continuation-passing Style",
  "name": "Time-slicing With Continuation-passing Style",
  "description": "Time-slicing With Continuation-passing Style to handle performance bottleneck",
  "keywords": [
    "CPS", "non-blocking"
  ],
  "articleBody": "Background story In January this year, I applied for an overseas dev job. I was asked to finish a project as homework. The project required a ton of computations on the front end, which posed a challenge as I must ensure no operations should block the main thread. I didn’t want to move the computation to a worker thread because the data was consumed in the main thread. Serializing and de-serializing a large set of data also has a performance cost. Furthermore, to improve indexing performance, I used Map to store the results, which is not serializable.\nThe task involved is as following:\nProcess a long list of news items, and index each item according to its tags. It looks like this in code:\nconst newsList = [ { uid: \"8be34939-bc25-4b9e-999d-2daf19fbea7b\", title: \"Adipisicing do eu magna ex non est eu labore nisi duis enim elit.\", tags: [\"reprehenderit\", \"cupidatat\", \"ad\", \"ea\", \"labore\"], }, { uid: \"488399fc-e474-4c52-a36c-625e2218fabe\", title: \"Elit aute tempor dolore do sunt.\", tags: [\"sint\", \"ea\", \"Lorem\", \"consectetur\", \"officia\"], }, { uid: \"0340b317-bd55-4c43-9982-94bf9d08b977\", title: \"Aliquip qui est sint veniam consectetur.\", tags: [\"sit\", \"ullamco\", \"consectetur\"], }, // ... omit remaining tens of thousands of items ]; const newsMap = new Map(); newsList.forEach((news) =\u003e { news.tags.forEach((tag) =\u003e { if (!newsMap.has(tag)) { newsMap.set(tag, [news]); } else { newsMap.get(tag).push(news); } }); }); In practice, I’d never done massive computations on the front-end, as JavaScript is not very efficient in handling CPU-intensive work. However, after some google search, I found a way to get around this limitation. The idea is to slice a big task to many small ones and put them to different callstacks.\nTime-slicing to the rescue If you’ve been working with React long enough, you’ve probably heard of React Fiber and time-slicing. React Fiber is a new reconciliation algorithm inside of the React core. It was designed to enable React to handle computations(mostly diffing caused by setState) in a non-blocking way. When high priority tasks occur due to user inputs, React can pause low priority tasks and handle them immediately.\nThe fiber architecture is very complicated. The implementation of it is quite cryptic and daunting. Implementing a fiber algorithm in my little project would be an overkill, if not infeasible. However, I can still do time-slicing in JavaScript in an easier way.\nThe solution lies in JavaScript’s power in asynchronicity and callback functions. Encountered with asynchronous tasks, we tend to shun away from callbacks because of the dreaded “callback hell.” However, when handled properly, callbacks and asynchronicity are a good fit. The callback soup I’m about to introduce is very powerful and irreplaceable.\nIf you used to pass callbacks in Ajax programming or node.js event handlers, you already know the technique I’m going to show you. I just find a fancier name for it: CPS(Continuation-passing Style).\nWhat is CPS Here’s an identity function you would write normally:\nfunction id(x) { return x; } and here is a CPS version:\nfunction id(x, cb) { cb(x); } In continuation-passing style, instead of “returning” the procedure to its caller, you invoke the “current continuation” callback (provided by the caller) on the return value.\nThe foundation of CPS is simple:\nProcedures can take a callback to invoke upon their return value. Slice it up! The atomic operation we need to do in processing the list is as following:\nfunction indexNews(item, tag) { if (!newsMap.has(tag)) { newsMap.set(tag, [item]); } else { newsMap.get(tag).push(item); } } So we need to slice our previous one big task to many small tasks like the above one. Here’s how to do it:\nfunction indexNews(item, tag, continuation) { if (!newsMap.has(tag)) { newsMap.set(tag, [item]); } else { newsMap.get(tag).push(item); } continuation(); } function iterate(list, processTask, continuation) { function handleOne(i, j, _continuation) { if (i \u003c list.length) { const item = list[i]; if (j \u003c item.tags.length) { processTask(item, item.tags[j], function handleNext() { handleOne(i, j + 1, _continuation); }); } else { handleOne(i + 1, 0, _continuation); } } else { _continuation(); } } handleOne(0, 0, continuation); } iterate(newsList, indexNews, () =\u003e { // Indexing is done, // we can enable features that depend on indexing safely here. console.log(\"done\"); }); This introduces too many recursions and makes our code way more complicated without improving performance. But we are very close!\nNotice a very important feature of the indexNews function. It takes a continuation callback and calls the continuation after finishing the current task. We’ve achieved “Inversion of Control” here. We can tell indexNews what to do in the next iteration.\nIn our case, we want it to move subsequent tasks to a new callstack so that we don’t put too much pressure on the current callstack.\nHowever, we don’t want to move every task to its own callstack, which is unnecessary.\nSo, here’s the rule:\nEach callstack can take 500 tasks, after that limit, we put the next 500 tasks in the next callstack. Repeat until all tasks are done.\nWe just need a few modifications to our previous code to achieve this:\nfunction indexNews(item, tag, continuation) { if (!newsMap.has(tag)) { newsMap.set(tag, [item]); } else { newsMap.get(tag).push(item); } if (indexNews.skip++ % 500 === 0) { setTimeout(continuation, 0); } else { continuation(); } } indexNews.skip = 0; Because of how event loop works in JavaScript, the setTimeout method will move its callback to the next execution callstack.\nSummary We introduced a technique we already knew and rediscovered the hidden power of it. Continuation-passing Style enables us to have control over what happens next when the current operation is completed. Relying on this feature, we first sliced a very big task to many small ones, and then chunked them into different call stacks.\nCheck out the project here .\n",
  "wordCount" : "939",
  "inLanguage": "en",
  "datePublished": "2020-08-06T00:00:00Z",
  "dateModified": "2020-08-06T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Lei Huang"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://leihuang.me/posts/time-slicing-with-cps/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Lei's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://leihuang.me/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://leihuang.me/" accesskey="h" title="Lei&#39;s Blog (Alt + H)">Lei&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://leihuang.me/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://leihuang.me/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://leihuang.me/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://leihuang.me/">Home</a>&nbsp;»&nbsp;<a href="https://leihuang.me/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Time-slicing With Continuation-passing Style
    </h1>
    <div class="post-description">
      Time-slicing With Continuation-passing Style to handle performance bottleneck
    </div>
    <div class="post-meta"><span title='2020-08-06 00:00:00 +0000 UTC'>August 6, 2020</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Lei Huang

</div>
  </header> 
  <div class="post-content"><h2 id="background-story">Background story<a hidden class="anchor" aria-hidden="true" href="#background-story">#</a></h2>
<p>In January this year, I applied for an overseas dev job. I was asked to finish a
project as homework. The project required a ton of computations on the front
end, which posed a challenge as I must ensure no operations should block the
main thread. I didn&rsquo;t want to move the computation to a worker thread because
the data was consumed in the main thread. Serializing and de-serializing a large
set of data also has a performance cost. Furthermore, to improve indexing
performance, I used <code>Map</code> to store the results, which is not serializable.</p>
<p>The task involved is as following:</p>
<p>Process a long list of news items, and index each item according to its tags. It
looks like this in code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">newsList</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">uid</span><span class="o">:</span> <span class="s2">&#34;8be34939-bc25-4b9e-999d-2daf19fbea7b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;Adipisicing do eu magna ex non est eu labore nisi duis enim elit.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;reprehenderit&#34;</span><span class="p">,</span> <span class="s2">&#34;cupidatat&#34;</span><span class="p">,</span> <span class="s2">&#34;ad&#34;</span><span class="p">,</span> <span class="s2">&#34;ea&#34;</span><span class="p">,</span> <span class="s2">&#34;labore&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">uid</span><span class="o">:</span> <span class="s2">&#34;488399fc-e474-4c52-a36c-625e2218fabe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;Elit aute tempor dolore do sunt.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;sint&#34;</span><span class="p">,</span> <span class="s2">&#34;ea&#34;</span><span class="p">,</span> <span class="s2">&#34;Lorem&#34;</span><span class="p">,</span> <span class="s2">&#34;consectetur&#34;</span><span class="p">,</span> <span class="s2">&#34;officia&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">uid</span><span class="o">:</span> <span class="s2">&#34;0340b317-bd55-4c43-9982-94bf9d08b977&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span><span class="o">:</span> <span class="s2">&#34;Aliquip qui est sint veniam consectetur.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;sit&#34;</span><span class="p">,</span> <span class="s2">&#34;ullamco&#34;</span><span class="p">,</span> <span class="s2">&#34;consectetur&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ... omit remaining tens of thousands of items
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">newsMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">newsList</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">news</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">news</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">tag</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newsMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">newsMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="p">[</span><span class="nx">news</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">newsMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">tag</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">news</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>In practice, I&rsquo;d never done massive computations on the front-end, as JavaScript
is not very efficient in handling CPU-intensive work. However, after some google
search, I found a way to get around this limitation. The idea is to slice a big
task to many small ones and put them to different callstacks.</p>
<h2 id="time-slicing-to-the-rescue">Time-slicing to the rescue<a hidden class="anchor" aria-hidden="true" href="#time-slicing-to-the-rescue">#</a></h2>
<p>If you&rsquo;ve been working with React long enough, you&rsquo;ve probably heard of React
Fiber and time-slicing. React Fiber is a new reconciliation algorithm inside of
the React core. It was designed to enable React to handle computations(mostly
diffing caused by <code>setState</code>) in a non-blocking way. When high priority tasks
occur due to user inputs, React can pause low priority tasks and handle them
immediately.</p>
<p>The fiber architecture is very complicated. The implementation of it is quite
cryptic and daunting. Implementing a fiber algorithm in my little project would
be an overkill, if not infeasible. However, I can still do time-slicing in
JavaScript in an easier way.</p>
<p>The solution lies in JavaScript&rsquo;s power in asynchronicity and callback
functions. Encountered with asynchronous tasks, we tend to shun away from
callbacks because of the dreaded &ldquo;callback hell.&rdquo; However, when handled
properly, callbacks and asynchronicity are a good fit. The callback soup I&rsquo;m
about to introduce is very powerful and irreplaceable.</p>
<p>If you used to pass callbacks in Ajax programming or <code>node.js</code> event handlers,
you already know the technique I&rsquo;m going to show you. I just find a fancier name
for it: CPS(Continuation-passing Style).</p>
<h2 id="what-is-cps">What is CPS<a hidden class="anchor" aria-hidden="true" href="#what-is-cps">#</a></h2>
<p>Here&rsquo;s an identity function you would write normally:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">id</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>and here is a CPS version:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">id</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cb</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In continuation-passing style, instead of &ldquo;returning&rdquo; the procedure to its
caller, you invoke the &ldquo;current continuation&rdquo; callback (provided by the caller)
on the return value.</p>
<p>The foundation of CPS is simple:</p>
<div class="callout-box">
  <p>
    Procedures can take a callback to invoke upon their return value.
  </p>
</div>
<h2 id="slice-it-up">Slice it up!<a hidden class="anchor" aria-hidden="true" href="#slice-it-up">#</a></h2>
<p>The atomic operation we need to do in processing the list is as following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">indexNews</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newsMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="p">[</span><span class="nx">item</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">tag</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So we need to slice our previous one big task to many small tasks like the above
one. Here&rsquo;s how to do it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">indexNews</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">continuation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newsMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="p">[</span><span class="nx">item</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">tag</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">continuation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">iterate</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">processTask</span><span class="p">,</span> <span class="nx">continuation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">handleOne</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">_continuation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">processTask</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="kd">function</span> <span class="nx">handleNext</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">handleOne</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">_continuation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">handleOne</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_continuation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_continuation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">handleOne</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">continuation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">iterate</span><span class="p">(</span><span class="nx">newsList</span><span class="p">,</span> <span class="nx">indexNews</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Indexing is done,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// we can enable features that depend on indexing safely here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;done&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>This introduces too many recursions and makes our code way more complicated
without improving performance. But we are very close!</p>
<p>Notice a very important feature of the <code>indexNews</code> function. It takes a
continuation callback and calls the continuation after finishing the current
task. We&rsquo;ve achieved &ldquo;Inversion of Control&rdquo; here. We can tell <code>indexNews</code> what
to do in the next iteration.</p>
<p>In our case, we want it to move subsequent tasks to a new callstack so that we
don&rsquo;t put too much pressure on the current callstack.</p>
<p>However, we don&rsquo;t want to move every task to its own callstack, which is
unnecessary.</p>
<p>So, here&rsquo;s the rule:</p>
<p>Each callstack can take 500 tasks, after that limit, we put the next 500 tasks
in the next callstack. Repeat until all tasks are done.</p>
<p>We just need a few modifications to our previous code to achieve this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">indexNews</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">continuation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newsMap</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">tag</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="p">[</span><span class="nx">item</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">tag</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">indexNews</span><span class="p">.</span><span class="nx">skip</span><span class="o">++</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">continuation</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">continuation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">indexNews</span><span class="p">.</span><span class="nx">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></div><p>Because of how event loop works in JavaScript, the <code>setTimeout</code> method will move
its callback to the next execution callstack.</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>We introduced a technique we already knew and rediscovered the hidden power of
it. Continuation-passing Style enables us to have control over what happens next
when the current operation is completed. Relying on this feature, we first
sliced a very big task to many small ones, and then chunked them into different
call stacks.</p>
<p>Check out the project 

<a href="https://github.com/leihuang23/news-list" target="_blank" rel="noopener noreferrer">
  here
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="16"
    height="16"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="external-icon"
  >
    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
    <polyline points="15 3 21 3 21 9"></polyline>
    <line x1="10" y1="14" x2="21" y2="3"></line>
  </svg>
</a>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://leihuang.me/tags/cps/">CPS</a></li>
      <li><a href="https://leihuang.me/tags/non-blocking/">Non-Blocking</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://leihuang.me/posts/time-slicing-with-coroutine/">
    <span class="title">« Prev</span>
    <br>
    <span>Time-slicing With Coroutine</span>
  </a>
  <a class="next" href="https://leihuang.me/posts/typewritter-in-rxjs/">
    <span class="title">Next »</span>
    <br>
    <span>Typewriter Effect With RxJS</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Time-slicing With Continuation-passing Style on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fleihuang.me%2fposts%2ftime-slicing-with-cps%2f&amp;title=Time-slicing%20With%20Continuation-passing%20Style&amp;summary=Time-slicing%20With%20Continuation-passing%20Style&amp;source=https%3a%2f%2fleihuang.me%2fposts%2ftime-slicing-with-cps%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Time-slicing With Continuation-passing Style on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fleihuang.me%2fposts%2ftime-slicing-with-cps%2f&title=Time-slicing%20With%20Continuation-passing%20Style">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Time-slicing With Continuation-passing Style on whatsapp"
            href="https://api.whatsapp.com/send?text=Time-slicing%20With%20Continuation-passing%20Style%20-%20https%3a%2f%2fleihuang.me%2fposts%2ftime-slicing-with-cps%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© 2025 Lei Huang</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
